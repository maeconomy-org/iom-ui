# Commands:
#   Start:    docker compose up -d
#   Stop:     docker compose down
#   Update:   ./deploy.sh update
#   Logs:     docker compose logs -f
#   Rollback: ./deploy.sh rollback

services:
  # ===========================================================================
  # Redis - Required for import queue
  # ===========================================================================
  redis:
    image: redis:7-alpine
    container_name: iom-redis
    restart: unless-stopped
    # Security: Run redis with password and disable dangerous commands
    command: >
      redis-server
      --requirepass ${REDIS_PASSWORD}
      --appendonly yes
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
      --rename-command FLUSHDB ""
      --rename-command FLUSHALL ""
      --rename-command DEBUG ""
    volumes:
      - ./redis-data:/data
    healthcheck:
      test: ['CMD', 'redis-cli', '-a', '${REDIS_PASSWORD}', 'ping']
      interval: 10s
      timeout: 5s
      retries: 3
    logging:
      driver: 'json-file'
      options:
        max-size: '10m'
        max-file: '3'

  # ===========================================================================
  # IoM UI Application
  # ===========================================================================
  ui:
    image: ghcr.io/${GH_ORG}/${APP_NAME}:${IMAGE_TAG}
    container_name: ${APP_NAME}
    restart: unless-stopped
    depends_on:
      redis:
        condition: service_healthy
    env_file:
      - .env

    ports:
      - '${PORT}:3000'

    environment:
      - NODE_ENV=${NODE_ENV}
      - PORT=${PORT}
      - BASE_API_URL=${BASE_API_URL}
      - UUID_API_URL=${UUID_API_URL}
      - REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379
      - CERTIFICATE_PATH=${CERTIFICATE_PATH}
      - CERTIFICATE_PASSWORD=${CERTIFICATE_PASSWORD}
      - VERIFY_CERTIFICATES=${VERIFY_CERTIFICATES}
      - HERE_API_KEY=${HERE_API_KEY}
      - SENTRY_DSN=${SENTRY_DSN}
      - SENTRY_RELEASE=Docker-${IMAGE_TAG}

    volumes:
      - ./certs:/app/certs:ro
      - ./logs:/app/logs:rw

    logging:
      driver: 'json-file'
      options:
        max-size: '10m'
        max-file: '5'

  # ===========================================================================
  # Nginx Reverse Proxy (Optional - uncomment if no host nginx)
  # ===========================================================================
  # nginx:
  #   image: nginx:alpine
  #   container_name: iom-nginx
  #   restart: unless-stopped
  #   ports:
  #     - '80:80'
  #     - '443:443'
  #   volumes:
  #     - ./nginx.conf:/etc/nginx/nginx.conf:ro
  #     - ./certbot/conf:/etc/letsencrypt:ro
  #     - ./certbot/www:/var/www/certbot:ro
  #   depends_on:
  #     - ui
  #   # Auto-reload nginx every 6h to pick up cert renewals
  #   command: '/bin/sh -c ''while :; do sleep 6h & wait $${!}; nginx -s reload; done & nginx -g "daemon off;"'''

  # ===========================================================================
  # Certbot SSL (Optional - uncomment with nginx)
  # ===========================================================================
  # certbot:
  #   image: certbot/certbot
  #   container_name: iom-certbot
  #   volumes:
  #     - ./certbot/conf:/etc/letsencrypt:rw
  #     - ./certbot/www:/var/www/certbot:rw
  #   # Auto-renew certs every 12h
  #   entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"

  # =========================================================================
  # Security Hardening (uncomment to enable)
  # =========================================================================
  # security_opt:
  #   - no-new-privileges:true
  # cap_drop:
  #   - ALL
  # read_only: true
  # tmpfs:
  #   - /tmp:noexec,nosuid,size=100m

  # =========================================================================
  # Resource Limits (uncomment to enable)
  # =========================================================================
  # deploy:
  #   resources:
  #     limits:
  #       cpus: '1.0'
  #       memory: 1G
  #     reservations:
  #       cpus: '0.25'
  #       memory: 256M
